name: Dependabot Auto Merge

on:
  workflow_run:
    workflows:
      - "Lint and Test"
      - "Integration Test"
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

# Prevent duplicate runs for the same PR
concurrency:
  group: dependabot-auto-merge-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false  # Let first run complete

jobs:
  dependabot-auto-merge:
    name: 'Auto-merge Dependabot PRs'
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.actor.login == 'dependabot[bot]'
    steps:
      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          PR_NUMBER=$(gh api "/repos/${REPO}/commits/${HEAD_SHA}/pulls" --jq '.[0].number')
          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "Could not find PR for commit ${HEAD_SHA}"
            exit 0
          fi
          echo "number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "Found PR #${PR_NUMBER}"

      - name: Check all required workflows passed
        id: checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number, skipping"
            exit 0
          fi

          # Use GitHub API to get check runs status
          CHECK_RUNS=$(gh api "/repos/${REPO}/commits/${{ github.event.workflow_run.head_sha }}/check-runs" --jq '.check_runs')

          # Define required checks
          REQUIRED_CHECKS=("check-code" "integration-test (production)" "integration-test (local)")

          ALL_PASSED=true
          for check in "${REQUIRED_CHECKS[@]}"; do
            STATUS=$(echo "$CHECK_RUNS" | jq -r --arg name "$check" '.[] | select(.name == $name) | .conclusion')
            if [ "$STATUS" != "success" ]; then
              echo "Check '$check' status: ${STATUS:-not found}"
              ALL_PASSED=false
            else
              echo "Check '$check' passed"
            fi
          done

          if [ "$ALL_PASSED" = "true" ]; then
            echo "All required checks passed!"
            echo "all_passed=true" >> "$GITHUB_OUTPUT"
          else
            echo "Not all checks passed yet, will retry on next workflow completion"
          fi

      - name: Enable auto-merge
        if: steps.checks.outputs.all_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Enable auto-merge - GitHub will merge when branch is up-to-date
          # This handles the "base branch changed" scenario automatically
          gh pr merge "$PR_NUMBER" --repo "$REPO" --auto --merge || {
            echo "Auto-merge already enabled or PR already merged"
          }

      - name: Attempt immediate merge with retry
        if: steps.checks.outputs.all_passed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Try to merge immediately with retries
          MAX_RETRIES=3
          RETRY_DELAY=10

          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "Merge attempt $attempt of $MAX_RETRIES"

            # Check if PR is still open
            PR_STATE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json state --jq '.state')
            if [ "$PR_STATE" = "MERGED" ]; then
              echo "PR already merged"
              exit 0
            fi
            if [ "$PR_STATE" = "CLOSED" ]; then
              echo "PR was closed without merging"
              exit 0
            fi

            # Check if PR is mergeable
            MERGEABLE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json mergeable --jq '.mergeable')
            if [ "$MERGEABLE" = "CONFLICTING" ]; then
              echo "PR has merge conflicts, cannot auto-merge"
              exit 0
            fi

            # Attempt merge
            if gh pr merge "$PR_NUMBER" --repo "$REPO" --merge; then
              echo "Successfully merged PR #${PR_NUMBER}"
              exit 0
            fi

            echo "Merge failed, waiting ${RETRY_DELAY}s before retry..."
            sleep $RETRY_DELAY
            RETRY_DELAY=$((RETRY_DELAY * 2))  # Exponential backoff
          done

          echo "All merge attempts failed - auto-merge is enabled, GitHub will merge when ready"
          # Don't fail the workflow - auto-merge is enabled as fallback
